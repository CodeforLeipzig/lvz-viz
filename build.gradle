plugins {
  id 'com.adarshr.test-logger' version '2.0.0'
  id 'com.avast.gradle.docker-compose' version '0.9.5'
  id 'com.gorylenko.gradle-git-properties' version '2.2.0'
  id 'eclipse-wtp'
  id 'idea'
  id 'io.franzbecker.gradle-lombok' version '3.2.0'
  id 'io.spring.dependency-management' version '1.0.8.RELEASE'
  id 'jacoco'
  id 'java'
  id 'org.ec4j.editorconfig' version '0.0.3'
  id 'org.sonarqube' version '2.8'
  id 'org.springframework.boot' version '2.1.8.RELEASE'
}

group = 'de.codefor.le'
version = '2.0.0-SNAPSHOT'
sourceCompatibility = '1.8'
targetCompatibility = '1.8'

defaultTasks 'build'

// update vulnerable transitive jackson dependencies for spring-boot and elasticsearch
// see https://app.snyk.io/vuln/SNYK-JAVA-COMFASTERXMLJACKSONCORE-467016
ext['jackson.version'] = '2.10.0'
ext['junit-jupiter.version'] = '5.5.2'

springBoot {
  mainClassName = 'de.codefor.le.LvzViz'
}

bootJar {
  launchScript()
}

repositories {
  mavenCentral()
}
dependencies {
  implementation "com.google.guava:guava:28.1-jre",
                 "org.jsoup:jsoup:1.12.1",
                 "edu.stanford.nlp:stanford-corenlp:3.9.2"

  // update vulnerable transitive dependencies for stanford-corenlp
  // see https://app.snyk.io/vuln/SNYK-JAVA-COMGOOGLEPROTOBUF-173761
  // see https://app.snyk.io/vuln/SNYK-JAVA-XALAN-31385
  // see https://app.snyk.io/vuln/SNYK-JAVA-XERCES-31585
  runtimeOnly "com.google.protobuf:protobuf-java:3.10.0",
              "xalan:xalan:2.7.2",
              "xerces:xercesImpl:2.12.0"

  implementation "org.springframework.boot:spring-boot-starter-web",
                 "org.springframework.boot:spring-boot-starter-logging",
                 "org.springframework.boot:spring-boot-starter-data-elasticsearch",
                 "org.springframework.boot:spring-boot-starter-actuator"

  testImplementation("org.springframework.boot:spring-boot-starter-test") {
    exclude group: 'junit', module: 'junit'
  }
  testImplementation "org.assertj:assertj-core:3.13.2"

  testImplementation "org.junit.jupiter:junit-jupiter-api",
                     "org.junit.jupiter:junit-jupiter-params"
  testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine"
}

dockerCompose {
  captureContainersOutput = false
}

editorconfig {
  includes = ['src/**', '*']
  excludes = ['**/images', '**/vendor', '*.gz', '*.log']
}

check.dependsOn editorconfigCheck

generateGitProperties {
  // see https://github.com/n0mer/gradle-git-properties/issues/35
  onlyIf {
    !source.isEmpty()
  }
}

jacocoTestReport {
  reports {
    xml.enabled true
    html.enabled false
  }
}

check.dependsOn jacocoTestReport

test {
  testLogging {
    exceptionFormat = 'full'
  }
  maxHeapSize = "2048m"
  useJUnitPlatform()
}

testlogger {
  showStandardStreams false
}

// see http://www.rehpoehler.de/gradle/Gradle-Eclipse-WTP-Beispiel.html
eclipse {
  project {
    natures = ['org.springframework.ide.eclipse.core.springnature',   // if you use springsourcr sts
               'org.springsource.ide.eclipse.gradle.core.nature',     // gradle plugin
               'org.eclipse.jdt.core.javanature',                     // default java
               'org.eclipse.wst.common.modulecore.ModuleCoreNature',  // default
               'org.eclipse.wst.common.project.facet.core.nature']    // if you want a facetted projekt

    buildCommand 'org.springframework.ide.eclipse.core.springbuilder' // Spring STS
  }

  classpath {
    defaultOutputDir = file('build/classes')

    downloadSources = true
    downloadJavadoc = false
  }

  wtp {
    facet {
      facet name: 'jst.web', version: '3.1' // Servlet 3.1
    }
  }
}
